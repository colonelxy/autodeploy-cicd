---
- name: "Creates backend app directory"
  file:
    path: ~/backend-app
    state: directory

- name: "Unarchive backend files"
  # become: True
  unarchive:
    src: artifact.tar.gz
    dest: ~/backend-app
    

- name: "Installing Node Dependencies"
  shell: |
    cd ~/backend-app
    npm i


- name: "Executing Node app with PM2"
  shell: |
    cd ~/backend-app/dist
    pm2 stop default
    pm2 start main.js

    pm2 save

  register: execute_node

- name: print message
  debug:
    msg: "{{ execute_node.stdout_lines }}"

- name: "Configure pm2 to start as service"
  # become: true
  shell: |
    sudo env -c "env PATH=$PATH:/usr/local/bin pm2 startup systemd -u ubuntu --hp /home/ubuntu"
    pm2 save


slack_configs:
  - channel: 'cicd3'
    send_resolved: true
    icon_url: https://avatars3.githubusercontent.com/u/3380462
    title: |-
    [{{ .Status | toUpper}}:{{ if eq .Status "firing"}}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }} for {{ .CommonLabels.job }}
      {{- if gt (len .CommonLabels) (len .GroupLabels) -}}
        {{* *}}(
        {{- with .Commonlabels.Remove .Grouplabels.Names }}
          {{- range $index, $label := .SortedPairs -}}
            {{ if $index }}, {{ end }}
            {{- $label.Name }}="{{ $label.Value -}}"
          {{- end }}
        {{- end -}}
        )
      {{- end }}
    text: >-
      {{ range .Alerts -}}
      "Alert:" {{ .Annotations.title }}{{ if .labels.severity }} - '{{ .Labels.severity }}'{{ end }}

      "Description:" {{ .Annotations.description }}

      "Details:"
        {{ range .Labels.SortedPairs }} = "{{ .Name }}:" '{{ .Value }}'
          {{ end }}
        {{ end }}